<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Kaizen{% endblock %}</title>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script>if(localStorage.getItem('kaizen-theme')==='light')document.documentElement.classList.add('light');</script>
  <style>
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface2: #222240;
      --border: #2a2a4a;
      --text: #e0e0e0;
      --text-dim: #888;
      --accent: #6c63ff;
      --accent-hover: #7f78ff;
      --danger: #e74c3c;
      --success: #2ecc71;
      --warning: #f39c12;
      --info: #3498db;
      --radius: 8px;
    }
    html.light {
      --bg: #f5f5f8;
      --surface: #ffffff;
      --surface2: #eeeef2;
      --border: #d0d0da;
      --text: #1a1a2e;
      --text-dim: #666;
      --accent: #5b52e0;
      --accent-hover: #4a42cc;
      --danger: #c0392b;
      --success: #27ae60;
      --warning: #e67e22;
      --info: #2980b9;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: var(--accent-hover); }

    /* Nav */
    nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    nav .logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.5px;
    }
    nav .links { display: flex; gap: 1rem; }
    nav .links a {
      color: var(--text-dim);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    nav .links a:hover, nav .links a.active {
      color: var(--text);
      background: var(--surface2);
    }
    nav .search-form {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
    }
    nav .search-form input[type="text"] {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius);
      font-size: 0.85rem;
      width: 220px;
    }
    nav .search-form input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }
    nav .search-form button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
    }
    nav .search-form button:hover { background: var(--accent-hover); }

    /* Main */
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      transition: border-color 0.15s;
    }
    .card:hover { border-color: var(--accent); }
    .card h3 { font-size: 1rem; margin-bottom: 0.25rem; }
    .card .meta {
      font-size: 0.8rem;
      color: var(--text-dim);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* Tags & badges */
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-kind { background: var(--surface2); color: var(--accent); border: 1px solid var(--border); }
    .badge-stale { background: rgba(243, 156, 18, 0.15); color: var(--warning); border: 1px solid rgba(243, 156, 18, 0.3); font-size: 0.7rem; }
    .tag {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      background: var(--surface2);
      border-radius: 3px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* Importance bar */
    .importance-bar {
      display: inline-block;
      width: 60px;
      height: 6px;
      background: var(--surface2);
      border-radius: 3px;
      overflow: hidden;
      vertical-align: middle;
    }
    .importance-bar .fill {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #c0392b; color: white; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dim);
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--text); }

    /* Forms */
    .form-group { margin-bottom: 1rem; }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 0.25rem;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: inherit;
    }
    .form-group textarea { min-height: 200px; resize: vertical; }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group input[type="range"] { width: 100%; }

    /* Detail content */
    .content-body {
      background: var(--surface2);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      white-space: pre-wrap;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.85rem;
      line-height: 1.7;
      overflow-x: auto;
    }
    .content-body.markdown-rendered {
      white-space: normal;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 0.9rem;
    }
    .markdown-rendered h1, .markdown-rendered h2, .markdown-rendered h3,
    .markdown-rendered h4, .markdown-rendered h5, .markdown-rendered h6 {
      margin-top: 1rem; margin-bottom: 0.5rem; color: var(--text);
    }
    .markdown-rendered h1 { font-size: 1.3rem; }
    .markdown-rendered h2 { font-size: 1.15rem; }
    .markdown-rendered h3 { font-size: 1rem; }
    .markdown-rendered p { margin-bottom: 0.6rem; }
    .markdown-rendered ul, .markdown-rendered ol { padding-left: 1.5rem; margin-bottom: 0.6rem; }
    .markdown-rendered li { margin-bottom: 0.2rem; }
    .markdown-rendered code {
      background: var(--surface); padding: 0.15rem 0.4rem; border-radius: 3px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 0.82rem;
    }
    .markdown-rendered pre {
      background: var(--surface); padding: 0.75rem 1rem; border-radius: var(--radius);
      overflow-x: auto; margin-bottom: 0.6rem;
    }
    .markdown-rendered pre code { background: none; padding: 0; }
    .markdown-rendered blockquote {
      border-left: 3px solid var(--accent); padding-left: 0.75rem;
      color: var(--text-dim); margin-bottom: 0.6rem;
    }
    .markdown-rendered a { color: var(--accent); }
    .markdown-rendered table { border-collapse: collapse; margin-bottom: 0.6rem; width: 100%; }
    .markdown-rendered th, .markdown-rendered td {
      border: 1px solid var(--border); padding: 0.35rem 0.6rem; font-size: 0.85rem;
    }
    .markdown-rendered th { background: var(--surface); }

    /* Page header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .page-header h1 { font-size: 1.5rem; }

    /* Timeline */
    .timeline-item {
      position: relative;
      padding-left: 2rem;
      padding-bottom: 1.5rem;
      border-left: 2px solid var(--border);
      margin-left: 0.5rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -5px;
      top: 0.5rem;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
    }
    .timeline-item .time {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .filters a {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      color: var(--text-dim);
    }
    .filters a:hover, .filters a.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(108, 99, 255, 0.1);
    }

    /* Relations */
    .relation-list { list-style: none; }
    .relation-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .relation-list li:last-child { border-bottom: none; }
    .relation-type {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      min-width: 80px;
    }

    /* Empty state */
    .empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-dim);
    }
    .empty p { font-size: 1.1rem; margin-bottom: 1rem; }

    /* Score */
    .score {
      font-size: 0.75rem;
      color: var(--text-dim);
      font-family: monospace;
    }

    /* Stale warning banner */
    .stale-banner {
      background: rgba(243, 156, 18, 0.1);
      border: 1px solid rgba(243, 156, 18, 0.3);
      border-radius: var(--radius);
      padding: 0.6rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: var(--warning);
    }
    .stale-banner code {
      background: rgba(243, 156, 18, 0.15);
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      font-size: 0.8rem;
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 4rem;
      right: 1.5rem;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .toast {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem 1.25rem;
      font-size: 0.85rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      animation: toast-in 0.3s ease-out, toast-out 0.3s ease-in 3.7s forwards;
      max-width: 400px;
    }
    .toast-success { border-left: 3px solid var(--success); color: var(--success); }
    .toast-error { border-left: 3px solid var(--danger); color: var(--danger); }
    .toast-info { border-left: 3px solid var(--info); color: var(--info); }
    .toast-warning { border-left: 3px solid var(--warning); color: var(--warning); }
    @keyframes toast-in { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toast-out { from { opacity: 1; } to { opacity: 0; } }

    /* Breadcrumbs */
    .breadcrumbs {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .breadcrumbs a { color: var(--text-dim); }
    .breadcrumbs a:hover { color: var(--accent); }
    .breadcrumbs .sep { color: var(--border); font-size: 0.7rem; }
    .breadcrumbs .current { color: var(--text); }

    /* Confirm modal */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 400;
      align-items: center;
      justify-content: center;
    }
    .modal-backdrop.open { display: flex; }
    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .modal-box h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .modal-box p { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.25rem; }
    .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }

    /* Mobile responsive */
    @media (max-width: 768px) {
      nav {
        flex-wrap: wrap;
        padding: 0.5rem 1rem;
        gap: 0.5rem;
      }
      nav .links { order: 3; width: 100%; gap: 0.5rem; overflow-x: auto; }
      nav .links a { font-size: 0.8rem; white-space: nowrap; }
      nav .search-form {
        order: 2;
        margin-left: 0;
        flex: 1;
        min-width: 0;
      }
      nav .search-form input[type="text"] { width: 100%; min-width: 0; }
      #search-kbd { display: none !important; }
      #theme-toggle { order: 2; }
      main { padding: 1rem 0.75rem; }
      .page-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .page-header h1 { font-size: 1.2rem; }
      .card { padding: 0.75rem 1rem; }
      .toast-container { right: 0.5rem; left: 0.5rem; }
      .toast { max-width: 100%; }
    }
    @media (max-width: 480px) {
      nav .logo { font-size: 1.1rem; }
      .content-body { padding: 0.75rem; font-size: 0.8rem; }
      .badge { font-size: 0.65rem; }
    }
  </style>
</head>
<body>
  <nav>
    <span class="logo">Kaizen</span>
    <div class="links">
      <a href="/">Memories</a>
      <a href="/timeline">Timeline</a>
      <a href="/graph">Graph</a>
      <a href="/analytics">Analytics</a>
    </div>
    <form class="search-form" action="/search" method="get">
      <div style="position:relative">
        <input type="text" name="q" id="nav-search" placeholder="Search memories..." autocomplete="off">
        <kbd style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.65rem;color:var(--text-dim);background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:0.1rem 0.35rem;pointer-events:none" id="search-kbd">Ctrl+K</kbd>
      </div>
      <button type="submit">Search</button>
    </form>
    <button id="theme-toggle" class="btn-outline" style="padding:0.35rem 0.6rem;font-size:0.85rem;cursor:pointer;background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:var(--radius)" title="Toggle theme">
      <span id="theme-icon">&#9790;</span>
    </button>
  </nav>
  <main>
    {% block breadcrumbs %}{% endblock %}
    {% block content %}{% endblock %}
  </main>
  <div class="toast-container" id="toast-container"></div>
  <div class="modal-backdrop" id="confirm-modal">
    <div class="modal-box">
      <h3 id="confirm-title"></h3>
      <p id="confirm-message"></p>
      <div class="modal-actions">
        <button class="btn btn-outline" id="confirm-cancel">Cancel</button>
        <button class="btn btn-danger" id="confirm-ok">Confirm</button>
      </div>
    </div>
  </div>
  <script>
  (function() {
    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    function updateIcon() { themeIcon.textContent = document.documentElement.classList.contains('light') ? '\u2600' : '\u263E'; }
    updateIcon();
    themeBtn.addEventListener('click', () => {
      document.documentElement.classList.toggle('light');
      localStorage.setItem('kaizen-theme', document.documentElement.classList.contains('light') ? 'light' : 'dark');
      updateIcon();
    });

    // Keyboard shortcuts
    const searchInput = document.getElementById('nav-search');
    const searchKbd = document.getElementById('search-kbd');
    searchInput.addEventListener('focus', () => { searchKbd.style.display = 'none'; });
    searchInput.addEventListener('blur', () => { if (!searchInput.value) searchKbd.style.display = ''; });
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) {
        e.preventDefault(); searchInput.focus();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault(); searchInput.focus();
      }
      if (e.key === 'Escape' && document.activeElement === searchInput) {
        searchInput.blur();
      }
    });

    // Active nav highlighting
    const path = window.location.pathname;
    document.querySelectorAll('nav .links a').forEach(a => {
      const href = a.getAttribute('href');
      if ((href === '/' && (path === '/' || path.startsWith('/memories'))) ||
          (href !== '/' && path.startsWith(href))) {
        a.classList.add('active');
      }
    });

    // Programmatic toast function
    window.showToast = function(message, type) {
      type = type || 'success';
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    };

    // Styled confirm modal
    window.showConfirm = function(title, message) {
      return new Promise(function(resolve) {
        const modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        modal.classList.add('open');
        function cleanup(result) {
          modal.classList.remove('open');
          document.getElementById('confirm-ok').onclick = null;
          document.getElementById('confirm-cancel').onclick = null;
          resolve(result);
        }
        document.getElementById('confirm-ok').onclick = function() { cleanup(true); };
        document.getElementById('confirm-cancel').onclick = function() { cleanup(false); };
        modal.onclick = function(e) { if (e.target === modal) cleanup(false); };
      });
    };

    // Toast notifications
    const params = new URLSearchParams(window.location.search);
    const msg = params.get('toast');
    const type = params.get('toast_type') || 'success';
    if (msg) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      toast.textContent = decodeURIComponent(msg);
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
      // Clean URL without reloading
      const url = new URL(window.location);
      url.searchParams.delete('toast');
      url.searchParams.delete('toast_type');
      history.replaceState(null, '', url.pathname + url.search);
    }
  })();
  </script>
</body>
</html>
