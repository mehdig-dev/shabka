{% extends "base.html" %}

{% block title %}Search â€” Kaizen{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs"><span class="current">Search</span></nav>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Search</h1>
</div>

<form action="/search" method="get" style="margin-bottom:1.5rem">
  <div style="display:flex;gap:0.5rem">
    <input type="text" name="q" value="{{ query }}" placeholder="Search memories..."
      style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.75rem;border-radius:var(--radius);font-size:0.9rem"
      autofocus>
    <input type="text" name="project" value="{{ project }}" placeholder="Project filter..."
      style="width:10rem;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.75rem;border-radius:var(--radius);font-size:0.9rem">
    <button type="submit" class="btn btn-primary">Search</button>
  </div>
</form>

{% if !query.is_empty() %}
  <p style="font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem">{{ results.len() }} result{% if results.len() != 1 %}s{% endif %} for "{{ query }}"</p>

  {% if results.is_empty() %}
  <div class="empty">
    <p>No results found</p>
  </div>
  {% else %}
    {% for r in results %}
    <a href="/memories/{{ r.memory.id }}" style="text-decoration:none;color:inherit">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <h3 class="search-highlight">{{ r.memory.title }}</h3>
          <span class="score">{{ "{:.3}"|format(r.score) }}</span>
        </div>
        <div class="meta">
          <span class="badge badge-kind">{{ r.memory.kind }}</span>
          {% if r.is_stale %}
            <span class="badge badge-stale">stale ({{ r.days_inactive }}d)</span>
          {% endif %}
          <span>
            <span class="importance-bar"><span class="fill" style="width:{{ r.memory.importance * 100.0 }}%"></span></span>
            {{ "{:.0}"|format(r.memory.importance * 100.0) }}%
          </span>
          <span>{{ r.memory.created_at.format("%Y-%m-%d %H:%M") }}</span>
          {% if r.relation_count > 0 %}
            <span>{{ r.relation_count }} relation{% if r.relation_count != 1 %}s{% endif %}</span>
          {% endif %}
        </div>
        {% if !r.memory.tags.is_empty() %}
        <div style="margin-top:0.35rem">
          {% for tag in r.memory.tags %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}
        <p class="search-highlight" style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-dim)">{{ r.memory.summary }}</p>
      </div>
    </a>
    {% endfor %}
  {% endif %}

  <script data-query="{{ query }}">
  (function() {
    const query = document.currentScript.dataset.query;
    if (!query) return;
    const words = query.split(/\s+/).filter(w => w.length > 1);
    if (words.length === 0) return;
    const pattern = new RegExp('(' + words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')', 'gi');
    document.querySelectorAll('.search-highlight').forEach(el => {
      const walk = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
      const nodes = [];
      while (walk.nextNode()) nodes.push(walk.currentNode);
      nodes.forEach(node => {
        if (!pattern.test(node.textContent)) return;
        pattern.lastIndex = 0;
        const span = document.createElement('span');
        span.innerHTML = node.textContent.replace(/[<>&"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])).replace(pattern, '<mark style="background:rgba(108,99,255,0.25);color:var(--text);border-radius:2px;padding:0 2px">$1</mark>');
        node.parentNode.replaceChild(span, node);
      });
    });
  })();
  </script>
{% endif %}
{% endblock %}
