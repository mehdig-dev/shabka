{% extends "base.html" %}

{% block title %}{{ memory.title }} — Kaizen{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs"><a href="/">Memories</a> <span class="sep">&rsaquo;</span> <span class="current">{{ memory.title }}</span></nav>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>{{ memory.title }}</h1>
  <div style="display:flex;gap:0.5rem">
    <a href="/memories/{{ memory.id }}/edit" class="btn btn-outline">Edit</a>
    <form method="post" action="/memories/{{ memory.id }}/delete" id="delete-form">
      <button type="submit" class="btn btn-danger">Delete</button>
    </form>
  </div>
</div>

{% if is_stale %}
<div class="stale-banner">
  This memory hasn't been accessed in {{ days_inactive }} days. Consider archiving it or running <code>kaizen prune</code>.
</div>
{% endif %}

<div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1rem">
  <span class="badge badge-kind">{{ memory.kind }}</span>
  <span class="badge" style="background:var(--surface2);color:var(--text-dim)">{{ memory.status }}</span>
  <span style="font-size:0.85rem;color:var(--text-dim)">
    Importance:
    <span class="importance-bar" style="width:80px"><span class="fill" style="width:{{ memory.importance * 100.0 }}%"></span></span>
    {{ "{:.0}"|format(memory.importance * 100.0) }}%
  </span>
</div>

{% if !memory.tags.is_empty() %}
<div style="margin-bottom:1rem">
  {% for tag in memory.tags %}
    <span class="tag">{{ tag }}</span>
  {% endfor %}
</div>
{% endif %}

<div class="content-body markdown-rendered" id="memory-content" style="margin-bottom:1.5rem">{{ memory.content }}</div>
<script src="https://unpkg.com/marked@15.0.4/marked.min.js"></script>
<script>
(function() {
  const el = document.getElementById('memory-content');
  if (el && typeof marked !== 'undefined') {
    const raw = el.textContent;
    el.innerHTML = marked.parse(raw);
  }
})();
</script>

<script>
document.getElementById('delete-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const ok = await window.showConfirm('Delete Memory', 'Permanently delete this memory? This cannot be undone.');
  if (ok) this.submit();
});
</script>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;font-size:0.8rem;color:var(--text-dim);margin-bottom:1.5rem">
  <div>
    <div>Created: {{ memory.created_at.format("%Y-%m-%d %H:%M:%S UTC") }}</div>
    <div>Updated: {{ memory.updated_at.format("%Y-%m-%d %H:%M:%S UTC") }}</div>
    <div>Accessed: {{ memory.accessed_at.format("%Y-%m-%d %H:%M:%S UTC") }}</div>
  </div>
  <div>
    <div>Source: {{ memory.source }}</div>
    <div>Scope: {{ memory.scope }}</div>
    <div>Created by: {{ memory.created_by }}</div>
    <div>ID: <code>{{ memory.id }}</code></div>
  </div>
</div>

<h2 style="font-size:1.1rem;margin-bottom:0.75rem">Relations ({{ relations.len() }})</h2>
{% if !relations.is_empty() %}
<ul class="relation-list">
  {% for rel in relations %}
  <li>
    <span class="relation-type">{{ rel.relation.relation_type }}</span>
    <a href="/memories/{{ rel.relation.target_id }}">{{ rel.target_title }}</a>
    <span class="score">strength: {{ "{:.1}"|format(rel.relation.strength) }}</span>
  </li>
  {% endfor %}
</ul>
{% else %}
<p style="font-size:0.82rem;color:var(--text-dim);margin-bottom:0.5rem">No relations yet — add one below</p>
{% endif %}

<!-- Add Relation form -->
<div id="add-relation-section" style="margin-top:0.75rem">
  <button class="btn btn-outline" style="font-size:0.8rem" onclick="document.getElementById('relation-form').style.display = document.getElementById('relation-form').style.display === 'none' ? 'flex' : 'none'">+ Add Relation</button>
  <div id="relation-form" style="display:none;margin-top:0.75rem;gap:0.5rem;align-items:flex-end;flex-wrap:wrap;padding:0.75rem;background:var(--surface2);border-radius:var(--radius)">
    <div style="flex:1;min-width:200px">
      <label style="display:block;font-size:0.75rem;color:var(--text-dim);margin-bottom:0.2rem">Target Memory ID</label>
      <input type="text" id="rel-target" placeholder="UUID" style="width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.5rem;border-radius:4px;font-size:0.8rem;font-family:monospace">
    </div>
    <div>
      <label style="display:block;font-size:0.75rem;color:var(--text-dim);margin-bottom:0.2rem">Type</label>
      <select id="rel-type" style="background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.5rem;border-radius:4px;font-size:0.8rem">
        <option value="related">related</option>
        <option value="fixes">fixes</option>
        <option value="caused_by">caused_by</option>
        <option value="supersedes">supersedes</option>
        <option value="contradicts">contradicts</option>
      </select>
    </div>
    <div>
      <label style="display:block;font-size:0.75rem;color:var(--text-dim);margin-bottom:0.2rem">Strength: <span id="rel-strength-val">0.5</span></label>
      <input type="range" id="rel-strength" min="0" max="1" step="0.1" value="0.5" style="width:100px" oninput="document.getElementById('rel-strength-val').textContent = this.value">
    </div>
    <button class="btn btn-primary" style="font-size:0.8rem" onclick="addRelation()">Add</button>
    <span id="rel-status" style="font-size:0.8rem;color:var(--success)"></span>
  </div>
</div>

<script>
async function addRelation() {
  const target = document.getElementById('rel-target').value.trim();
  const type = document.getElementById('rel-type').value;
  const strength = parseFloat(document.getElementById('rel-strength').value);
  const status = document.getElementById('rel-status');

  if (!target) { status.textContent = 'Enter a target ID'; status.style.color = 'var(--danger)'; return; }

  try {
    const resp = await fetch('/api/v1/memories/{{ memory.id }}/relate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target_id: target, relation_type: type, strength }),
    });
    if (resp.ok) {
      status.textContent = 'Added!';
      status.style.color = 'var(--success)';
      setTimeout(() => location.reload(), 500);
    } else {
      const data = await resp.json();
      status.textContent = data.error || 'Failed';
      status.style.color = 'var(--danger)';
    }
  } catch (e) {
    status.textContent = e.message;
    status.style.color = 'var(--danger)';
  }
}
</script>

<!-- Similar Memories -->
<div style="margin-top:1.5rem">
  <h2 style="font-size:1.1rem;margin-bottom:0.75rem">Similar Memories</h2>
  {% if similar_memories.is_empty() %}
  <p style="font-size:0.82rem;color:var(--text-dim)">No similar memories found</p>
  {% else %}
  {% for sim in similar_memories %}
  <a href="/memories/{{ sim.id }}" class="card" style="display:block;text-decoration:none;color:var(--text)">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="font-size:0.9rem;margin-bottom:0.15rem">{{ sim.title }}</h3>
        <span class="badge badge-kind" style="font-size:0.65rem">{{ sim.kind }}</span>
      </div>
      <span class="score" style="font-size:0.8rem">{{ "{:.0}"|format(sim.score * 100.0) }}%</span>
    </div>
  </a>
  {% endfor %}
  {% endif %}
</div>

<!-- Audit History -->
<div style="margin-top:1.5rem">
  <h2 style="font-size:1.1rem;margin-bottom:0.75rem">History ({{ history_events.len() }})</h2>
  {% if history_events.is_empty() %}
  <p style="font-size:0.82rem;color:var(--text-dim)">No history events</p>
  {% else %}
  <div style="font-size:0.8rem">
    {% for event in history_events %}
    <div style="display:flex;gap:1rem;padding:0.35rem 0;border-bottom:1px solid var(--border)">
      <span style="color:var(--text-dim);min-width:140px">{{ event.timestamp.format("%Y-%m-%d %H:%M") }}</span>
      <span style="min-width:80px;{% match event.action %}{% when EventAction::Created %}color:var(--success){% when EventAction::Updated %}color:var(--warning){% when EventAction::Deleted %}color:var(--danger){% when EventAction::Archived %}color:var(--text-dim){% when EventAction::Imported %}color:var(--info){% when EventAction::Superseded %}color:var(--warning){% endmatch %}">{{ event.action }}</span>
      {% if !event.changes.is_empty() %}<span style="color:var(--text-dim)">{% for c in event.changes %}{{ c.field }}: {{ c.old_value }} → {{ c.new_value }}{% if !loop.last %}, {% endif %}{% endfor %}</span>{% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

{% if !relations.is_empty() %}
<!-- Chain Explorer -->
<div id="chain-section" style="margin-top:1.5rem">
  <h2 style="font-size:1.1rem;margin-bottom:0.75rem">Chain Explorer</h2>
  <div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:0.75rem;font-size:0.8rem">
    <label style="color:var(--text-dim)">Depth:
      <select id="chain-depth" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:0.2rem 0.4rem;border-radius:var(--radius);font-size:0.8rem">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </label>
    <span style="color:var(--text-dim)">Relations:</span>
    <label style="color:var(--text);font-size:0.78rem"><input type="checkbox" class="chain-rel" value="related" checked> related</label>
    <label style="color:var(--text);font-size:0.78rem"><input type="checkbox" class="chain-rel" value="fixes" checked> fixes</label>
    <label style="color:var(--text);font-size:0.78rem"><input type="checkbox" class="chain-rel" value="caused_by" checked> caused_by</label>
    <label style="color:var(--text);font-size:0.78rem"><input type="checkbox" class="chain-rel" value="supersedes" checked> supersedes</label>
    <label style="color:var(--text);font-size:0.78rem"><input type="checkbox" class="chain-rel" value="contradicts" checked> contradicts</label>
  </div>
  <div id="chain-placeholder" style="width:100%;height:400px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;cursor:pointer" onclick="document.getElementById('chain-placeholder').style.display='none';document.getElementById('chain-cy').style.display='block';loadChainGraph();">
    <span style="color:var(--text-dim);font-size:0.9rem">Click to load chain graph</span>
  </div>
  <div id="chain-cy" style="width:100%;height:400px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:none"></div>
  <div id="chain-error" style="display:none;padding:0.75rem;color:var(--danger);font-size:0.85rem"></div>
</div>

<script src="https://unpkg.com/cytoscape@3.30.4/dist/cytoscape.min.js"></script>
<script>
(function() {
  const KIND_COLORS = {
    observation: '#6c63ff', error: '#e74c3c', fix: '#2ecc71',
    decision: '#f39c12', pattern: '#3498db', lesson: '#9b59b6',
    fact: '#1abc9c', preference: '#e67e22', todo: '#95a5a6',
  };
  const MEMORY_ID = '{{ memory.id }}';
  let chainCy = null;

  async function loadChain() {
    const depth = document.getElementById('chain-depth').value;
    const checked = [...document.querySelectorAll('.chain-rel:checked')].map(c => c.value);
    const errorEl = document.getElementById('chain-error');
    errorEl.style.display = 'none';
    if (checked.length === 0) return;

    const cyEl = document.getElementById('chain-cy');
    cyEl.style.opacity = '0.5';

    const url = `/api/memories/${MEMORY_ID}/chain?depth=${depth}&relation=${checked.join(',')}`;
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      cyEl.style.opacity = '1';
      renderChain(data);
    } catch (e) {
      cyEl.style.opacity = '1';
      errorEl.textContent = `Failed to load chain: ${e.message}`;
      errorEl.style.display = 'block';
    }
  }

  function renderChain(data) {
    const elements = [];

    // Center node
    elements.push({
      data: {
        id: data.center.id,
        label: data.center.title.length > 30 ? data.center.title.slice(0, 27) + '...' : data.center.title,
        kind: data.center.kind,
        color: KIND_COLORS[data.center.kind] || '#6c63ff',
        size: 40,
        isCenter: true,
      }
    });

    // Neighbor nodes
    data.nodes.forEach(n => {
      elements.push({
        data: {
          id: n.id,
          label: n.title.length > 30 ? n.title.slice(0, 27) + '...' : n.title,
          kind: n.kind,
          color: KIND_COLORS[n.kind] || '#6c63ff',
          size: 18 + n.importance * 22,
          isCenter: false,
        }
      });
    });

    // Edges
    data.edges.forEach(e => {
      elements.push({
        data: {
          source: e.source,
          target: e.target,
          label: e.relation_type,
          strength: e.strength,
        }
      });
    });

    if (chainCy) chainCy.destroy();

    chainCy = cytoscape({
      container: document.getElementById('chain-cy'),
      elements: elements,
      style: [
        {
          selector: 'node',
          style: {
            'background-color': 'data(color)',
            'label': 'data(label)',
            'color': '#c0c0c0',
            'font-size': '8px',
            'text-valign': 'bottom',
            'text-margin-y': 4,
            'width': 'data(size)',
            'height': 'data(size)',
            'border-width': 2,
            'border-color': 'data(color)',
            'border-opacity': 0.3,
            'text-max-width': '100px',
            'text-wrap': 'ellipsis',
            'text-outline-color': '#0f0f1a',
            'text-outline-width': 2,
            'cursor': 'pointer',
          }
        },
        {
          selector: 'node[?isCenter]',
          style: {
            'border-width': 3,
            'border-color': '#ffffff',
            'border-opacity': 1,
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 1.5,
            'line-color': '#2a2a4a',
            'target-arrow-color': '#2a2a4a',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'arrow-scale': 0.7,
            'opacity': 0.6,
            'label': 'data(label)',
            'font-size': '7px',
            'color': '#888',
            'text-rotation': 'autorotate',
            'text-outline-color': '#0f0f1a',
            'text-outline-width': 1.5,
          }
        },
      ],
      layout: {
        name: 'breadthfirst',
        directed: false,
        roots: `#${MEMORY_ID}`,
        spacingFactor: 1.2,
        animate: true,
        animationDuration: 400,
      },
      wheelSensitivity: 0.3,
    });

    // Click node → navigate to its detail page
    chainCy.on('tap', 'node', (evt) => {
      const nodeId = evt.target.id();
      if (nodeId !== MEMORY_ID) {
        window.location.href = `/memories/${nodeId}`;
      }
    });
  }

  // loadChainGraph is called when the user clicks the placeholder
  window.loadChainGraph = function() {
    loadChain();
    // Attach event listeners for controls after first load
    document.getElementById('chain-depth').addEventListener('change', loadChain);
    document.querySelectorAll('.chain-rel').forEach(cb => cb.addEventListener('change', loadChain));
  };
})();
</script>
{% endif %}

<div style="margin-top:2rem">
  <a href="/" class="btn btn-outline">&larr; Back to list</a>
</div>
{% endblock %}
