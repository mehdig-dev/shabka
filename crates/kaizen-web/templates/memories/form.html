{% extends "base.html" %}

{% block title %}{% if memory.is_some() %}Edit{% else %}New{% endif %} Memory — Kaizen{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumbs">
  <a href="/">Memories</a> <span class="sep">&rsaquo;</span>
  {% match memory %}
    {% when Some with (m) %}<a href="/memories/{{ m.id }}">{{ m.title }}</a> <span class="sep">&rsaquo;</span> <span class="current">Edit</span>
    {% when None %}<span class="current">New Memory</span>
  {% endmatch %}
</nav>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>{% if memory.is_some() %}Edit Memory{% else %}New Memory{% endif %}</h1>
</div>

{% match memory %}
  {% when Some with (m) %}
  <form method="post" action="/memories/{{ m.id }}/update" class="memory-form">
  {% when None %}
  <form method="post" action="/memories" class="memory-form">
{% endmatch %}

  <div class="form-group">
    <label for="title">Title</label>
    <input type="text" id="title" name="title" required autofocus
      placeholder="Short, descriptive title..."
      value="{% match memory %}{% when Some with (m) %}{{ m.title }}{% when None %}{% endmatch %}">
  </div>

  <div class="form-group">
    <label for="content">Content <span style="font-size:0.75rem;color:var(--text-dim);font-weight:400">— Supports Markdown</span> <span id="char-count" style="float:right;font-size:0.75rem;color:var(--text-dim)"></span></label>
    <textarea id="content" name="content" required placeholder="Detailed content in markdown...">{% match memory %}{% when Some with (m) %}{{ m.content }}{% when None %}{% endmatch %}</textarea>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
    <div class="form-group">
      <label for="kind">Kind</label>
      <select id="kind" name="kind">
        {% for opt in kind_options %}
          <option value="{{ opt.name }}" {% if opt.selected %}selected{% endif %}>{{ opt.name }}</option>
        {% endfor %}
      </select>
      <div id="kind-desc" style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem"></div>
    </div>

    <div class="form-group">
      <label for="tags">Tags <span style="font-size:0.75rem;color:var(--text-dim)">(comma-separated)</span></label>
      <input type="text" id="tags" name="tags"
        value="{% match memory %}{% when Some with (m) %}{{ m.tags.join(", ") }}{% when None %}{% endmatch %}"
        placeholder="e.g. rust, debugging, performance">
    </div>
  </div>

  <div class="form-group">
    <label for="project">Project <span style="font-size:0.75rem;color:var(--text-dim)">(optional)</span></label>
    <input type="text" id="project" name="project"
      value="{% match memory %}{% when Some with (m) %}{% match m.project_id %}{% when Some with (p) %}{{ p }}{% when None %}{% endmatch %}{% when None %}{% endmatch %}"
      placeholder="e.g. kaizen, my-app">
  </div>

  <div class="form-group">
    <label for="importance">Importance: <span id="imp-val" style="color:var(--accent);font-weight:600">{% match memory %}{% when Some with (m) %}{{ "{:.0}"|format(m.importance * 100.0) }}{% when None %}50{% endmatch %}</span>%</label>
    <input type="range" id="importance" name="importance" min="0" max="1" step="0.05"
      value="{% match memory %}{% when Some with (m) %}{{ m.importance }}{% when None %}0.5{% endmatch %}">
    <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-dim);margin-top:0.15rem">
      <span>Low</span><span>Medium</span><span>High</span>
    </div>
  </div>

  <div style="display:flex;gap:0.75rem;margin-top:1.5rem">
    <button type="submit" class="btn btn-primary">
      {% if memory.is_some() %}Save Changes{% else %}Create Memory{% endif %}
    </button>
    <a href="{% match memory %}{% when Some with (m) %}/memories/{{ m.id }}{% when None %}/{% endmatch %}" class="btn btn-outline">Cancel</a>
  </div>
</form>

<style>
  .memory-form {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
  }
  .memory-form input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    outline: none;
  }
  .memory-form input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid var(--bg);
  }
  .memory-form input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid var(--bg);
  }
  .memory-form textarea {
    min-height: 250px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.85rem;
    line-height: 1.7;
    tab-size: 2;
  }
</style>

<script>
(function() {
  // Live importance display
  const slider = document.getElementById('importance');
  const display = document.getElementById('imp-val');
  slider.addEventListener('input', function() {
    display.textContent = Math.round(this.value * 100);
  });

  // Content character counter
  const content = document.getElementById('content');
  const counter = document.getElementById('char-count');
  function updateCount() {
    const len = content.value.length;
    counter.textContent = len > 0 ? len.toLocaleString() + ' / 50,000' : '0 / 50,000';
  }
  content.addEventListener('input', updateCount);
  updateCount();

  // Kind description
  const KIND_DESCRIPTIONS = {
    observation: 'Something you noticed',
    decision: 'A choice you made and why',
    pattern: 'A recurring behavior or approach',
    error: 'A mistake or bug encountered',
    fix: 'How a problem was solved',
    preference: 'A preferred tool, style, or approach',
    fact: 'A verified piece of information',
    lesson: 'A takeaway from experience',
    todo: 'Something to do later',
  };
  const kindSelect = document.getElementById('kind');
  const kindDesc = document.getElementById('kind-desc');
  function updateKindDesc() {
    kindDesc.textContent = KIND_DESCRIPTIONS[kindSelect.value] || '';
  }
  kindSelect.addEventListener('change', updateKindDesc);
  updateKindDesc();

  // Tab key inserts spaces in textarea
  content.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = this.selectionStart;
      const end = this.selectionEnd;
      this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
      this.selectionStart = this.selectionEnd = start + 2;
    }
  });
})();
</script>
{% endblock %}
