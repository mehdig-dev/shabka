{% if !query.is_empty() %}
  <p style="font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem">{{ results.len() }} result{% if results.len() != 1 %}s{% endif %} for "{{ query }}"</p>

  {% if results.is_empty() %}
  <div class="empty">
    <p>No results found</p>
  </div>
  {% else %}
    {% for r in results %}
    <a href="/memories/{{ r.memory.id }}" style="text-decoration:none;color:inherit">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <h3 class="search-highlight">{{ r.memory.title }}</h3>
          <span class="score">{{ "{:.3}"|format(r.score) }}</span>
        </div>
        <div class="meta">
          <span class="badge badge-kind">{{ r.memory.kind }}</span>
          {% if r.is_stale %}
            <span class="badge badge-stale">stale ({{ r.days_inactive }}d)</span>
          {% endif %}
          <span>
            <span class="importance-bar"><span class="fill" style="width:{{ r.memory.importance * 100.0 }}%"></span></span>
            {{ "{:.0}"|format(r.memory.importance * 100.0) }}%
          </span>
          <span>{{ r.memory.created_at.format("%Y-%m-%d %H:%M") }}</span>
          {% if r.relation_count > 0 %}
            <span>{{ r.relation_count }} relation{% if r.relation_count != 1 %}s{% endif %}</span>
          {% endif %}
        </div>
        {% if !r.memory.tags.is_empty() %}
        <div style="margin-top:0.35rem">
          {% for tag in r.memory.tags %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}
        <p class="search-highlight" style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-dim)">{{ r.memory.summary }}</p>
      </div>
    </a>
    {% endfor %}
  {% endif %}

  <script data-query="{{ query }}">
  (function() {
    var query = document.currentScript.dataset.query;
    if (!query) return;
    var words = query.split(/\s+/).filter(function(w) { return w.length > 1; });
    if (words.length === 0) return;
    var pattern = new RegExp('(' + words.map(function(w) { return w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }).join('|') + ')', 'gi');
    document.querySelectorAll('.search-highlight').forEach(function(el) {
      var walk = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
      var nodes = [];
      while (walk.nextNode()) nodes.push(walk.currentNode);
      nodes.forEach(function(node) {
        if (!pattern.test(node.textContent)) return;
        pattern.lastIndex = 0;
        var span = document.createElement('span');
        var escaped = node.textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        var highlighted = escaped.replace(pattern, '<mark style="background:rgba(108,99,255,0.25);color:var(--text);border-radius:2px;padding:0 2px">$1</mark>');
        span.innerHTML = highlighted;
        node.parentNode.replaceChild(span, node);
      });
    });
  })();
  </script>
{% endif %}
